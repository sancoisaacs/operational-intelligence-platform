<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forensic Intelligence Pro | V8.5 Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { background-color: #0a0e1a; color: #cbd5e1; font-family: 'Inter', sans-serif; }
        
        .glass-panel { 
            background: linear-gradient(135deg, #1a1f35 0%, #0f1420 100%);
            border: 1px solid #2d3548; 
            border-radius: 16px; 
            overflow: hidden; 
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .glass-panel:hover { 
            border-color: #38bdf8;
            box-shadow: 0 8px 30px rgba(56, 189, 248, 0.2);
            transform: translateY(-2px);
        }
        
        .strategy-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            border: 2px solid #6366f1;
            box-shadow: 0 0 40px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }
        .strategy-card::after {
            content: "";
            position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, transparent, #818cf8, transparent);
            animation: scanline 3s infinite linear;
        }
        @keyframes scanline { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        .insight-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #38bdf8;
            position: relative;
            overflow: hidden;
        }
        
        .risk-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .risk-low { background: #064e3b; color: #34d399; border: 1px solid #10b981; }
        .risk-medium { background: #78350f; color: #fbbf24; border: 1px solid #f59e0b; }
        .risk-high { background: #7f1d1d; color: #f87171; border: 1px solid #ef4444; }

        .action-item {
            background: #0f172a;
            border-left: 4px solid #6366f1;
            padding: 16px;
            margin: 8px 0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .action-item:hover {
            background: #1e293b;
            border-left-color: #818cf8;
            transform: translateX(4px);
        }

        .metric-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            background: linear-gradient(135deg, #818cf8 0%, #38bdf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out; }
    </style>
</head>
<body class="h-screen flex flex-col p-4 overflow-hidden">

    <header class="flex justify-between items-center mb-6 shrink-0">
        <div>
            <h1 class="text-2xl font-bold text-white tracking-wide">FORENSIC INTELLIGENCE <span class="text-indigo-400">PRO V8.5</span></h1>
            <p class="text-xs text-slate-500">Multi-Factor Analysis ‚Ä¢ Smart Logic ‚Ä¢ Strategic Decision Engine</p>
        </div>
        <div class="flex gap-4 items-center">
            <div id="model-status" class="hidden px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-900/50 to-teal-900/50 border border-emerald-700 text-xs text-emerald-400 flex items-center gap-2">
                <div class="pulse-dot bg-emerald-400"></div>
                <span class="font-bold">Intelligence Engine Active</span>
            </div>
            
            <div id="export-buttons" class="hidden flex gap-2">
                <button onclick="exportToExcel()" class="bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5 flex items-center gap-2 text-sm">
                    <span>üìä Excel</span>
                </button>
            </div>
            
            <button onclick="loadSampleData()" class="bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5 flex items-center gap-2">
                <span>üß™ LOAD SAMPLE DATA</span>
            </button>

            <label class="cursor-pointer bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5 flex items-center gap-2">
                <span>üìä INGEST FILE</span>
                <input type="file" multiple accept=".csv,.xlsx,.xls" class="hidden" onchange="processFiles(this.files)">
            </label>
        </div>
    </header>

    <div id="dashboard" class="flex-1 overflow-y-auto grid grid-cols-1 gap-6 pb-20 hidden">
        
        <div id="executive-summary" class="hidden"></div>

        <div id="strategy-zone" class="hidden"></div>

        <div id="risk-zone" class="hidden"></div>

        <div id="prediction-zone" class="hidden"></div>

        <div id="pattern-zone" class="hidden"></div>

        <div id="correlation-zone" class="hidden"></div>
        
        <div id="charts-zone" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>

        <div id="anomaly-zone" class="hidden"></div>
    </div>

    <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-slate-600">
        <div class="w-20 h-20 mb-6 rounded-full bg-gradient-to-br from-indigo-900/50 to-purple-900/50 flex items-center justify-center text-4xl border-2 border-indigo-700">
            üß†
        </div>
        <p class="text-2xl font-bold text-slate-300">Intelligence System Ready</p>
        <p class="text-sm mt-3 text-slate-500">Upload your data files to begin forensic analysis</p>
    </div>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 1. CONFIG & ICONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ICONS = {
        flavor: (name) => {
            const n = name.toLowerCase();
            if (n.includes('choc')) return 'üç´'; if (n.includes('berr')) return 'üçì'; if (n.includes('lemon')) return 'üçã';
            if (n.includes('vanilla')) return 'üç¶'; if (n.includes('mint')) return 'üåø'; return 'üç®';
        },
        weather: (code) => {
            if (code === 0) return '‚òÄÔ∏è'; if (code >= 1 && code <= 3) return '‚õÖ'; if (code >= 51) return 'üåßÔ∏è'; return 'üå°Ô∏è';
        },
        trend: (slope) => slope > 0 ? 'üìà' : slope < 0 ? 'üìâ' : '‚û°Ô∏è',
        risk: (level) => level === 'low' ? 'üü¢' : level === 'medium' ? 'üü°' : 'üî¥',
        action: (priority) => priority === 'critical' ? 'üö®' : priority === 'high' ? '‚ö°' : 'üí°'
    };

    let INTELLIGENCE = {
        topFlavor: null, topFlavorRevenue: 0, secondFlavor: null, totalRevenue: 0, averageSales: 0,
        tempSlope: 0, tempIntercept: 0, modelR2: 0, mae: 0, mape: 0,
        patterns: [], volatility: 0, riskScore: 0, riskFactors: [], recommendations: [],
        regressionPoints: [] // Needed for Scatter Plot
    };

    function decodeDate(serial) {
        if (!serial) return "-";
        if (typeof serial === 'string') return serial;
        const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 2. MAIN PROCESSING (WITH V8.1 SMART LOGIC)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function processFiles(files) {
        if (!files.length) return;
        
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('charts-zone').innerHTML = '';
        
        const status = document.getElementById('model-status');
        status.classList.remove('hidden');
        status.innerHTML = '<div class="pulse-dot bg-yellow-400"></div><span class="font-bold">Processing Data...</span>';

        const processedData = [];

        for (let file of files) {
            const data = await parseExcel(file);
            if (!data.length) continue;

            const keys = Object.keys(data[0]).map(k => k.toLowerCase());
            let type = 'Unknown';
            if (keys.some(k => k.includes('flavor') || k.includes('product'))) type = 'Flavor';
            else if (keys.some(k => k.includes('temp'))) type = 'Weather';
            else if (keys.includes('date') && keys.some(k => k.includes('sales') || k.includes('revenue'))) type = 'Timeline';

            processedData.push({ type, data, filename: file.name });
        }

        executeIntelligenceEngine(processedData);
    }

    function parseExcel(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'array' });
                resolve(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]));
            };
        });
    }

    async function executeIntelligenceEngine(processedData) {
        const status = document.getElementById('model-status');
        const weatherSet = processedData.find(d => d.type === 'Weather');
        const flavorSet = processedData.find(d => d.type === 'Flavor');
        const timelineSet = processedData.find(d => d.type === 'Timeline');

        if (weatherSet && timelineSet) {
            trainIntelligenceEngine(weatherSet.data, timelineSet.data);
        }
        
        if (flavorSet) analyzeProductPerformance(flavorSet.data);
        if (timelineSet) detectPatterns(timelineSet.data);

        calculateRiskProfile();
        generateRecommendations();

        // RENDER V8 VISUALS
        renderExecutiveSummary();
        renderStrategyPanel();
        renderRiskAnalysis();
        if (weatherSet) await runAdvancedForecast();
        renderPatternInsights();
        renderCorrelationMatrix(processedData);
        
        // RENDER CHARTS
        if (flavorSet) createWidget('Flavor', flavorSet.data);
        if (timelineSet) createWidget('Timeline', timelineSet.data);
        
        // SWITCH: If we have Weather + Sales, show SCATTER. Else Line.
        if (weatherSet && timelineSet) {
            createWidget('Correlation', null); // V8.1 Scatter Logic
        } else if (weatherSet) {
            createWidget('Weather', weatherSet.data);
        }
        
        renderAnomalyDetection();

        status.innerHTML = '<div class="pulse-dot bg-emerald-400"></div><span class="font-bold">Intelligence Engine Active</span>';
        document.getElementById('export-buttons').classList.remove('hidden');
    }

    function loadSampleData() {
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('charts-zone').innerHTML = '';
        const status = document.getElementById('model-status');
        status.classList.remove('hidden');
        status.innerHTML = '<div class="pulse-dot bg-yellow-400"></div><span class="font-bold">Synthesizing Sample Data...</span>';

        const timelineData = [], weatherData = [], flavorData = [];
        const startDate = new Date(); startDate.setDate(startDate.getDate() - 30);
        const flavors = [{ name: "Midnight Chocolate", base: 100 }, { name: "Solar Strawberry", base: 80 }, { name: "Nebula Vanilla", base: 60 }];

        for (let i = 0; i < 30; i++) {
            const d = new Date(startDate); d.setDate(d.getDate() + i);
            const dateStr = d.toLocaleDateString();
            const temp = 60 + Math.random() * 35;
            // Strong correlation
            const sales = 500 + ((temp - 60) * 50) + ((Math.random() - 0.5) * 200);
            
            timelineData.push({ "Date": dateStr, "Total Sales": Math.round(sales) });
            weatherData.push({ "Date": dateStr, "Avg Temp (F)": Math.round(temp) });
        }
        
        flavors.forEach(f => {
            flavorData.push({ "Flavor Name": f.name, "Units Sold": f.base * 10 + Math.floor(Math.random() * 100) });
        });

        setTimeout(() => {
            executeIntelligenceEngine([
                { type: 'Timeline', data: timelineData },
                { type: 'Weather', data: weatherData },
                { type: 'Flavor', data: flavorData }
            ]);
        }, 800);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 3. CORE ANALYTICS (SMART JOIN + R2)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function trainIntelligenceEngine(weatherData, timelineData) {
        // SMART MATCHING by DATE
        const getDateKey = (row) => {
            const val = Object.values(row)[0]; 
            if (typeof val === 'number') return Math.round(val);
            return new Date(val).toDateString(); 
        };

        const salesMap = new Map();
        const salesKey = Object.keys(timelineData[0]).find(k => k.match(/sales|revenue/i));
        timelineData.forEach(r => {
            const cleanVal = parseFloat(String(r[salesKey]).replace(/[^0-9.]/g,''));
            if (!isNaN(cleanVal)) salesMap.set(getDateKey(r), cleanVal);
        });

        const alignedData = [];
        const tempKey = Object.keys(weatherData[0]).find(k => k.match(/temp/i));
        
        weatherData.forEach(r => {
            const key = getDateKey(r);
            if (salesMap.has(key)) {
                const t = parseFloat(r[tempKey]);
                if (!isNaN(t)) alignedData.push({ temp: t, sales: salesMap.get(key) });
            }
        });

        if (alignedData.length < 5) return;

        // REGRESSION
        const n = alignedData.length;
        const sumX = alignedData.reduce((a, b) => a + b.temp, 0);
        const sumY = alignedData.reduce((a, b) => a + b.sales, 0);
        const sumXY = alignedData.reduce((a, b) => a + b.temp * b.sales, 0);
        const sumX2 = alignedData.reduce((a, b) => a + b.temp * b.temp, 0);

        INTELLIGENCE.tempSlope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        INTELLIGENCE.tempIntercept = (sumY - INTELLIGENCE.tempSlope * sumX) / n;
        INTELLIGENCE.averageSales = sumY / n;

        // R2 SCORE
        const ssRes = alignedData.reduce((sum, d) => {
            const pred = INTELLIGENCE.tempSlope * d.temp + INTELLIGENCE.tempIntercept;
            return sum + Math.pow(d.sales - pred, 2);
        }, 0);
        const ssTot = alignedData.reduce((sum, d) => sum + Math.pow(d.sales - INTELLIGENCE.averageSales, 2), 0);
        INTELLIGENCE.modelR2 = 1 - (ssRes / ssTot);

        // SAVE POINTS FOR CHART
        INTELLIGENCE.regressionPoints = alignedData.map(d => ({ x: d.temp, y: d.sales }));
        
        // ERROR METRICS
        let absError = 0;
        alignedData.forEach(d => {
            const pred = INTELLIGENCE.tempSlope * d.temp + INTELLIGENCE.tempIntercept;
            absError += Math.abs(d.sales - pred);
        });
        
        INTELLIGENCE.mae = absError / n;
        INTELLIGENCE.mape = (absError / n / INTELLIGENCE.averageSales) * 100;
        
        const stdDev = Math.sqrt(ssTot / n);
        INTELLIGENCE.volatility = (stdDev / INTELLIGENCE.averageSales) * 100;
    }

    function analyzeProductPerformance(flavorData) {
        const labelKey = Object.keys(flavorData[0]).find(k => k.match(/flavor|name/i));
        const valueKey = Object.keys(flavorData[0]).find(k => k.match(/units|sold/i));
        const map = {};
        let total = 0;
        flavorData.forEach(r => {
            const k = (r[labelKey]||'').trim().toUpperCase();
            const val = parseFloat(r[valueKey])||0;
            map[k] = (map[k] || {name: (r[labelKey]||'').trim(), val: 0});
            map[k].val += val;
            total += val;
        });
        
        const sorted = Object.values(map).sort((a,b) => b.val - a.val);
        INTELLIGENCE.topFlavor = sorted[0].name;
        INTELLIGENCE.topFlavorRevenue = sorted[0].val;
        INTELLIGENCE.secondFlavor = sorted[1]?.name;
        INTELLIGENCE.totalRevenue = total * 5; 
        
        const marketShares = sorted.map(item => (item.val / total) * 100);
        const hhi = marketShares.reduce((sum, share) => sum + Math.pow(share, 2), 0);
        INTELLIGENCE.marketConcentration = hhi > 2500 ? 'High' : hhi > 1500 ? 'Moderate' : 'Low';
    }

    function detectPatterns(timelineData) {
        const salesKey = Object.keys(timelineData[0]).find(k => k.toLowerCase().includes('sales'));
        const sales = timelineData.map(r => parseFloat(String(r[salesKey]).replace(/[^0-9.]/g,'')));
        
        const firstHalf = sales.slice(0, Math.floor(sales.length/2));
        const secondHalf = sales.slice(Math.floor(sales.length/2));
        const avgFirst = firstHalf.reduce((a,b)=>a+b,0) / firstHalf.length;
        const avgSecond = secondHalf.reduce((a,b)=>a+b,0) / secondHalf.length;
        const trendStrength = ((avgSecond - avgFirst) / avgFirst) * 100;
        
        INTELLIGENCE.patterns.push({
            type: 'Trend',
            direction: trendStrength > 5 ? 'Growing' : trendStrength < -5 ? 'Declining' : 'Stable',
            strength: Math.abs(trendStrength).toFixed(1) + '%',
            icon: ICONS.trend(trendStrength)
        });
        
        INTELLIGENCE.patterns.push({
            type: 'Volatility',
            level: INTELLIGENCE.volatility > 30 ? 'High' : INTELLIGENCE.volatility > 15 ? 'Moderate' : 'Low',
            value: INTELLIGENCE.volatility.toFixed(1) + '%',
            icon: INTELLIGENCE.volatility > 30 ? '‚ö†Ô∏è' : 'üìä'
        });
    }

    function calculateRiskProfile() {
        let riskFactors = [];
        const modelFitPct = INTELLIGENCE.modelR2 * 100;
        if (modelFitPct < 60) riskFactors.push({ factor: 'Weak Model Fit (Low R¬≤)', severity: 'high', impact: 20, description: 'Temperature explains < 60% of sales' });
        if (INTELLIGENCE.mape > 20) riskFactors.push({ factor: 'High Forecast Error', severity: 'medium', impact: 15, description: `Avg error ${INTELLIGENCE.mape.toFixed(1)}%` });
        if (INTELLIGENCE.marketConcentration === 'High') riskFactors.push({ factor: 'High Market Concentration', severity: 'medium', impact: 15, description: 'Dependent on single product' });
        if (INTELLIGENCE.volatility > 25) riskFactors.push({ factor: 'High Sales Volatility', severity: 'medium', impact: 15, description: 'Unpredictable demand' });
        
        INTELLIGENCE.riskScore = riskFactors.reduce((sum, f) => sum + f.impact, 0);
        INTELLIGENCE.riskFactors = riskFactors;
    }

    function generateRecommendations() {
        const recs = [];
        if (INTELLIGENCE.tempSlope > 0) {
            recs.push({
                title: `Stock Up on ${INTELLIGENCE.topFlavor} During Heat Waves`, priority: 'critical', impact: 'High Revenue Impact',
                action: `Increase ${INTELLIGENCE.topFlavor} inventory by 40-50% when forecast exceeds 80¬∞F`,
                rationale: `Correlation shows ${(INTELLIGENCE.tempSlope * 10).toFixed(0)}% sales jump per 10¬∞F`,
                roi: '+35%', timeframe: 'Immediate'
            });
        }
        if (INTELLIGENCE.marketConcentration === 'High') {
            recs.push({
                title: 'Diversify Product Portfolio', priority: 'high', impact: 'Risk Mitigation',
                action: `Promote ${INTELLIGENCE.secondFlavor} and introduce variants`, rationale: 'Single product dependency',
                roi: '-25% Risk', timeframe: '1-2 months'
            });
        }
        INTELLIGENCE.recommendations = recs;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 4. UI RENDERING (ORIGINAL V8 VISUALS)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function renderExecutiveSummary() {
        const zone = document.getElementById('executive-summary');
        zone.classList.remove('hidden');
        const riskLevel = INTELLIGENCE.riskScore > 50 ? 'high' : INTELLIGENCE.riskScore > 25 ? 'medium' : 'low';
        const riskColor = riskLevel === 'high' ? 'rose' : riskLevel === 'medium' ? 'amber' : 'emerald';
        
        zone.innerHTML = `
            <div class="glass-panel p-8 animate-fade-in-up">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-full bg-indigo-900/50 flex items-center justify-center text-2xl">üìä</div>
                    <div><h2 class="text-2xl font-bold text-white">Executive Intelligence Summary</h2><p class="text-slate-400 text-sm">Real-time strategic overview</p></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-2">Total Revenue</div>
                        <div class="stat-number">$${(INTELLIGENCE.totalRevenue || 0).toFixed(0)}</div>
                        <div class="text-emerald-400 text-sm mt-2 font-semibold">‚ñ≤ Active Market</div>
                    </div>
                    <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-2">Model Fit (R¬≤)</div>
                        <div class="stat-number">${(INTELLIGENCE.modelR2 * 100).toFixed(0)}%</div>
                        <div class="text-xs text-slate-500 mt-2">Error: ¬±${INTELLIGENCE.mape.toFixed(1)}%</div>
                    </div>
                    <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-2">Risk Score</div>
                        <div class="stat-number text-${riskColor}-400">${INTELLIGENCE.riskScore}</div>
                        <div class="mt-2"><span class="risk-badge risk-${riskLevel}">${riskLevel} risk</span></div>
                    </div>
                    <div class="bg-slate-900/50 p-6 rounded-xl border border-slate-700">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-2">Leader</div>
                        <div class="text-xl font-bold text-white mt-2 truncate">${INTELLIGENCE.topFlavor || 'N/A'}</div>
                        <div class="text-sky-400 text-sm mt-2 font-semibold">${ICONS.flavor(INTELLIGENCE.topFlavor||'')} Top Seller</div>
                    </div>
                </div>
            </div>`;
    }

    function renderStrategyPanel() {
        const zone = document.getElementById('strategy-zone');
        if (!INTELLIGENCE.recommendations.length) return;
        zone.classList.remove('hidden');
        const topRec = INTELLIGENCE.recommendations[0];
        
        zone.innerHTML = `
            <div class="strategy-card p-8 rounded-xl animate-fade-in-up" style="animation-delay: 0.1s">
                <div class="flex flex-col md:flex-row justify-between items-start gap-6 mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-indigo-500/20 flex items-center justify-center text-4xl border-2 border-indigo-500">${ICONS.action(topRec.priority)}</div>
                        <div>
                            <div class="flex items-center gap-3 mb-2"><h2 class="text-2xl font-bold text-white">Primary Directive</h2><span class="risk-badge" style="background:#7c3aed;color:#c4b5fd;border-color:#8b5cf6">${topRec.priority}</span></div>
                            <p class="text-indigo-300">${topRec.impact}</p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <div class="metric-pill bg-emerald-900/30 border-emerald-700 text-emerald-400"><span>üí∞</span><span>${topRec.roi}</span></div>
                        <div class="metric-pill bg-sky-900/30 border-sky-700 text-sky-400"><span>‚è±Ô∏è</span><span>${topRec.timeframe}</span></div>
                    </div>
                </div>
                <div class="bg-black/30 p-6 rounded-lg border border-white/10 mb-6">
                    <h3 class="text-xl font-bold text-yellow-400 mb-3">${topRec.title}</h3>
                    <p class="text-white text-lg mb-4">${topRec.action}</p>
                    <p class="text-slate-300 text-sm"><strong class="text-indigo-400">Rationale:</strong> ${topRec.rationale}</p>
                </div>
                <div class="grid md:grid-cols-3 gap-4">
                    ${INTELLIGENCE.recommendations.slice(1, 4).map(rec => `
                        <div class="action-item">
                            <div class="flex items-start gap-3 mb-2">
                                <span class="text-xl">${ICONS.action(rec.priority)}</span>
                                <div class="flex-1"><div class="text-white font-bold text-sm mb-1">${rec.title}</div><div class="text-slate-400 text-xs">${rec.impact}</div></div>
                            </div>
                            <div class="flex gap-2 mt-3"><span class="text-xs px-2 py-1 rounded bg-indigo-900/50 text-indigo-300">${rec.roi}</span></div>
                        </div>`).join('')}
                </div>
            </div>`;
    }

    function renderRiskAnalysis() {
        const zone = document.getElementById('risk-zone');
        if (!INTELLIGENCE.riskFactors || !INTELLIGENCE.riskFactors.length) return;
        zone.classList.remove('hidden');
        
        const riskLevel = INTELLIGENCE.riskScore > 50 ? 'high' : INTELLIGENCE.riskScore > 25 ? 'medium' : 'low';
        
        zone.innerHTML = `
            <div class="glass-panel p-8 animate-fade-in-up" style="animation-delay: 0.2s">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3"><span class="text-3xl">üõ°Ô∏è</span><div><h2 class="text-xl font-bold text-white">Risk Matrix</h2><p class="text-slate-400 text-sm">Vulnerability assessment</p></div></div>
                    <div class="text-right"><div class="text-slate-400 text-xs uppercase">Aggregate</div><div class="text-3xl font-bold ${riskLevel === 'high' ? 'text-rose-400' : riskLevel === 'medium' ? 'text-amber-400' : 'text-emerald-400'}">${INTELLIGENCE.riskScore}/100</div></div>
                </div>
                <div class="space-y-3">
                    ${INTELLIGENCE.riskFactors.map(f => `
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700 flex items-center justify-between">
                            <div class="flex-1"><div class="flex items-center gap-3 mb-1"><span class="risk-badge risk-${f.severity}">${f.severity}</span><span class="text-white font-bold">${f.factor}</span></div><p class="text-slate-400 text-sm">${f.description}</p></div>
                            <div class="text-right"><div class="text-slate-500 text-xs">Impact</div><div class="text-2xl font-bold text-rose-400">${f.impact}</div></div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }

    function renderPatternInsights() {
        const zone = document.getElementById('pattern-zone');
        if (!INTELLIGENCE.patterns.length) return;
        zone.classList.remove('hidden');
        
        zone.innerHTML = `
            <div class="glass-panel p-8 animate-fade-in-up" style="animation-delay: 0.3s">
                <div class="flex items-center gap-3 mb-6"><span class="text-3xl">üîç</span><div><h2 class="text-xl font-bold text-white">Pattern Recognition</h2><p class="text-slate-400 text-sm">Detected behaviors</p></div></div>
                <div class="grid md:grid-cols-3 gap-4">
                    ${INTELLIGENCE.patterns.map(p => `
                        <div class="bg-gradient-to-br from-slate-900/80 to-slate-800/50 p-6 rounded-lg border border-slate-700">
                            <div class="flex items-center justify-between mb-3"><span class="text-3xl">${p.icon}</span><span class="text-2xl font-bold text-sky-400">${p.value}</span></div>
                            <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">${p.type}</div>
                            <div class="text-white font-bold text-lg">${p.level || p.direction}</div>
                        </div>`).join('')}
                </div>
            </div>`;
    }

    function renderCorrelationMatrix(datasets) {
        const zone = document.getElementById('correlation-zone');
        if (datasets.length < 2) return;
        zone.classList.remove('hidden');
        const corr = INTELLIGENCE.modelR2 * 100;
        
        zone.innerHTML = `
            <div class="glass-panel p-8 animate-fade-in-up" style="animation-delay: 0.4s">
                <div class="flex items-center gap-3 mb-6"><span class="text-3xl">üéØ</span><div><h2 class="text-xl font-bold text-white">Correlation Matrix</h2><p class="text-slate-400 text-sm">Cross-dimensional strength</p></div></div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="bg-slate-900/50 p-6 rounded-lg border border-slate-700">
                        <div class="text-slate-400 text-xs uppercase mb-2">Temp ‚Üí Sales</div>
                        <div class="text-3xl font-bold" style="color:${corr>70?'#10b981':corr>40?'#f59e0b':'#ef4444'}">${corr.toFixed(0)}%</div>
                        <div class="text-xs text-slate-500">${corr>70?'Strong':corr>40?'Moderate':'Weak'} correlation</div>
                    </div>
                </div>
            </div>`;
    }

    function renderAnomalyDetection() {
        if (INTELLIGENCE.volatility < 25) return;
        const zone = document.getElementById('anomaly-zone');
        zone.classList.remove('hidden');
        zone.innerHTML = `
            <div class="glass-panel p-8 animate-fade-in-up" style="animation-delay: 0.5s">
                <div class="flex items-center gap-3 mb-6"><span class="text-3xl">‚ö†Ô∏è</span><div><h2 class="text-xl font-bold text-white">Anomaly Detection</h2><p class="text-slate-400 text-sm">Unusual patterns</p></div></div>
                <div class="bg-amber-900/20 border border-amber-700 p-6 rounded-lg">
                    <div class="flex items-start gap-4">
                        <div class="text-4xl">üìâ</div>
                        <div class="flex-1"><div class="text-amber-400 font-bold text-lg mb-2">High Volatility Detected</div><p class="text-slate-300 mb-3">Sales variance of ${INTELLIGENCE.volatility.toFixed(1)}% indicates unpredictable patterns.</p></div>
                    </div>
                </div>
            </div>`;
    }

    async function runAdvancedForecast() {
        const url = "https://api.open-meteo.com/v1/forecast?latitude=-33.92&longitude=18.42&daily=temperature_2m_max,weathercode&temperature_unit=fahrenheit&timezone=auto&forecast_days=7";
        try {
            const res = await fetch(url);
            const json = await res.json();
            const zone = document.getElementById('prediction-zone');
            zone.classList.remove('hidden');
            
            let totalPredicted = 0;
            const cards = json.daily.time.map((t, i) => {
                const temp = json.daily.temperature_2m_max[i];
                const rev = (INTELLIGENCE.tempSlope * temp) + INTELLIGENCE.tempIntercept;
                totalPredicted += rev;
                const date = new Date(t).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'});
                return `
                    <div class="flex flex-col items-center p-5 bg-gradient-to-br from-slate-900/80 to-slate-800/50 rounded-xl border border-slate-700 hover:border-sky-500 hover:shadow-lg transition-all transform hover:scale-105">
                        <span class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">${date}</span>
                        <div class="text-4xl my-3">${ICONS.weather(json.daily.weathercode[i])}</div>
                        <span class="${temp>85?'text-rose-400':'text-sky-400'} font-bold text-xl">${Math.round(temp)}¬∞F</span>
                        <div class="w-full h-px bg-slate-700 my-3"></div>
                        <span class="text-emerald-400 font-bold text-lg">$${rev.toFixed(0)}</span>
                    </div>`;
            }).join('');

            zone.innerHTML = `
                <div class="insight-card p-8 rounded-xl animate-fade-in-up">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3"><span class="text-3xl">üîÆ</span><div><h2 class="text-2xl font-bold text-white">7-Day Forecast</h2><p class="text-slate-400 text-sm">Predictive revenue modeling</p></div></div>
                        <div class="text-right"><div class="text-slate-500 text-xs uppercase">Projected</div><div class="text-2xl font-bold text-emerald-400">$${totalPredicted.toFixed(0)}</div></div>
                    </div>
                    <div class="grid grid-cols-3 md:grid-cols-7 gap-3">${cards}</div>
                </div>`;
        } catch(e) { console.error('Forecast error:', e); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 5. VISUALIZATION ENGINE (WITH SCATTER PLOT)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function createWidget(type, rawData) {
        const board = document.getElementById('charts-zone');
        let chartConfig = {};
        let insightHTML = '';
        
        const chartId = 'chart-' + Math.random().toString(36).substr(2, 9);

        // --- CORRELATION SCATTER PLOT ---
        if (type === 'Correlation') {
            const pts = INTELLIGENCE.regressionPoints;
            const minX = Math.min(...pts.map(p=>p.x)) - 5;
            const maxX = Math.max(...pts.map(p=>p.x)) + 5;
            const lineStart = { x: minX, y: INTELLIGENCE.tempSlope * minX + INTELLIGENCE.tempIntercept };
            const lineEnd = { x: maxX, y: INTELLIGENCE.tempSlope * maxX + INTELLIGENCE.tempIntercept };

            insightHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3"><span class="text-4xl">üìâ</span><div><div class="text-rose-400 font-bold text-lg">Temp vs Revenue</div><div class="text-xs text-slate-500">R¬≤ = ${(INTELLIGENCE.modelR2*100).toFixed(1)}%</div></div></div>
                </div>`;

            chartConfig = {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Sales', data: pts, backgroundColor: '#818cf8', borderColor: '#1e293b', borderWidth: 1, pointRadius: 5 },
                        { type: 'line', label: 'Trend', data: [lineStart, lineEnd], borderColor: '#f43f5e', borderWidth: 2, pointRadius: 0, borderDash: [5,5] }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', position: 'bottom', title:{display:true, text:'Temperature (¬∞F)', color:'#64748b'}, grid: { color: '#1e293b' } }, y: { title:{display:true, text:'Revenue ($)', color:'#64748b'}, grid: { color: '#1e293b' } } }, plugins: { legend: { display: false } } }
            };
        }
        else if (type === 'Timeline') {
            const dateKey = Object.keys(rawData[0]).find(k => k.match(/date/i));
            const salesKey = Object.keys(rawData[0]).find(k => k.match(/sales|revenue/i));
            const labels = rawData.map(r => decodeDate(r[dateKey]));
            const values = rawData.map(r => parseFloat(String(r[salesKey]).replace(/[^0-9.]/g,'')));
            
            insightHTML = `<div class="flex items-center gap-3 mb-6"><span class="text-4xl">üìà</span><div><div class="text-sky-400 font-bold text-lg">Sales Velocity</div><div class="text-xs text-slate-500">Revenue Trajectory</div></div></div>`;
            chartConfig = { type: 'line', data: { labels, datasets: [{ label: 'Sales', data: values, borderColor: '#38bdf8', backgroundColor: 'rgba(56, 189, 248, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { color: '#1e293b' } } }, plugins: { legend: { display: false } } } };
        }
        else if (type === 'Flavor') {
            const labelKey = Object.keys(rawData[0]).find(k => k.match(/flavor|name/i));
            const valueKey = Object.keys(rawData[0]).find(k => k.match(/units|sold/i));
            const map = {};
            rawData.forEach(r => { const k = (r[labelKey]||'').trim().toUpperCase(); map[k] = (map[k]||0) + (parseFloat(r[valueKey])||0); });
            const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]);
            
            insightHTML = `<div class="flex items-center gap-3 mb-6"><span class="text-4xl">üç¶</span><div><div class="text-amber-400 font-bold text-lg">Product Mix</div><div class="text-xs text-slate-500">Top: ${sorted[0][0]}</div></div></div>`;
            chartConfig = { type: 'bar', data: { labels: sorted.map(s=>s[0]), datasets: [{ label: 'Units', data: sorted.map(s=>s[1]), backgroundColor: sorted.map((_,i)=>i===0?'#f59e0b':'#475569') }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { color: '#1e293b' } } }, plugins: { legend: { display: false } } } };
        }

        const div = document.createElement('div');
        div.className = 'glass-panel p-6 shadow-2xl flex flex-col h-[450px]';
        div.innerHTML = `${insightHTML}<div class="flex-1 w-full relative"><canvas id="${chartId}"></canvas></div>`;
        board.appendChild(div);
        setTimeout(() => new Chart(document.getElementById(chartId).getContext('2d'), chartConfig), 100);
    }
    
    function exportToExcel() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([["METRIC", "VALUE"], ["Revenue", INTELLIGENCE.totalRevenue], ["R2", INTELLIGENCE.modelR2], ["Risk", INTELLIGENCE.riskScore]]);
        XLSX.utils.book_append_sheet(wb, ws, "Forensic Report");
        XLSX.writeFile(wb, "Forensic_Report.xlsx");
    }

</script>
</body>
</html>
