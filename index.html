<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence Intelligence | Report Generator v9.7</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ink: { 950: '#050505', 900: '#0d0d0d', 800: '#1a1a1a', 700: '#2d2d2d', 600: '#404040' },
                        electric: { 500: '#00f0ff', 400: '#33f3ff', 300: '#66f6ff' },
                        warning: { 500: '#ff6b35', 400: '#ff8c5a' },
                        success: { 500: '#00ff88', 400: '#33ffa0' }
                    },
                    fontFamily: { 
                        sans: ['Work Sans', 'sans-serif'],
                        mono: ['Space Mono', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        /* DASHBOARD STYLES */
        body { background: #050505; color: #e0e0e0; font-family: 'Work Sans', sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0d0d0d; }
        ::-webkit-scrollbar-thumb { background: #2d2d2d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #404040; }
        .glow-text { text-shadow: 0 0 20px rgba(0, 240, 255, 0.5), 0 0 40px rgba(0, 240, 255, 0.2); }
        .metric-card { background: linear-gradient(135deg, rgba(0, 240, 255, 0.05) 0%, rgba(0, 240, 255, 0.01) 100%); border: 1px solid rgba(0, 240, 255, 0.2); position: relative; overflow: hidden; }
        .metric-card:hover { border-color: rgba(0, 240, 255, 0.4); transform: translateY(-2px); transition: all 0.3s; }
        .data-row { transition: all 0.2s; border-bottom: 1px solid #1a1a1a; }
        .data-row:hover { background: linear-gradient(90deg, rgba(0, 240, 255, 0.05) 0%, transparent 100%); border-left: 2px solid #00f0ff; }
        .tag { background: rgba(0, 240, 255, 0.1); color: #00f0ff; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; display: inline-block; margin: 2px; }
        .pulse-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; } @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .3; } }
        .stat-number { font-size: 2rem; font-weight: 700; font-family: 'Space Mono', monospace; }
        .sentiment-positive { color: #00ff88; } .sentiment-negative { color: #ff6b35; } .sentiment-neutral { color: #808080; }
        canvas { max-height: 300px; }
        
        /* PDF EXPORT STYLES (Applied temporarily during export) */
        .pdf-mode {
            background: white !important;
            color: black !important;
            padding: 40px !important;
            height: auto !important;
            overflow: visible !important;
        }
        .pdf-mode h1, .pdf-mode h2, .pdf-mode h3 { color: black !important; border-bottom-color: #ccc !important; text-shadow: none !important; }
        .pdf-mode .report-metric, .pdf-mode .insight-box {
            background: #f5f5f5 !important;
            border: 1px solid #ccc !important;
            color: black !important;
            page-break-inside: avoid;
        }
        .pdf-mode table th { background: #eee !important; color: black !important; }
        .pdf-mode table td { border-bottom: 1px solid #ddd !important; color: black !important; }
        .pdf-mode .chart-container {
            background: white !important;
            border: 1px solid #ccc !important;
            page-break-inside: avoid; /* Prevents charts from splitting across pages */
            margin-bottom: 20px !important;
        }
        .pdf-mode #reportMap { border: 1px solid #ccc !important; }

        /* REPORT STYLES */
        #reportOutput { max-height: 70vh; overflow-y: auto; background: #0d0d0d; padding: 30px; border-radius: 8px; }
        #reportOutput h1 { font-size: 2rem; font-weight: 700; margin-bottom: 20px; color: #00f0ff; }
        #reportOutput h2 { font-size: 1.5rem; font-weight: 600; margin-top: 30px; margin-bottom: 15px; color: #00f0ff; border-bottom: 2px solid rgba(0, 240, 255, 0.3); padding-bottom: 5px; }
        #reportOutput h3 { font-size: 1.2rem; font-weight: 600; margin-top: 20px; margin-bottom: 10px; color: #33f3ff; }
        #reportOutput p { margin-bottom: 12px; line-height: 1.6; }
        #reportOutput ul { margin-left: 20px; margin-bottom: 15px; }
        #reportOutput li { margin-bottom: 8px; list-style-type: disc; }
        #reportOutput .report-metric { background: rgba(0, 240, 255, 0.1); padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #00f0ff; }
        #reportOutput .insight-box { background: rgba(255, 107, 53, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 3px solid #ff6b35; }
        #reportOutput table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        #reportOutput th { background: rgba(0, 240, 255, 0.2); padding: 10px; text-align: left; font-weight: 600; }
        #reportOutput td { padding: 10px; border-bottom: 1px solid #2d2d2d; }
        #reportOutput .chart-container { margin: 25px 0; background: white; padding: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="flex justify-between items-center px-8 py-6 border-b border-ink-700">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold glow-text">EVIDENCE INTELLIGENCE</h1>
            <span class="text-xs text-gray-600 font-mono">v9.7 | STABLE</span>
        </div>
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <div id="engineStatus" class="w-2 h-2 rounded-full bg-gray-500"></div>
                <span id="engineText" class="text-xs text-gray-400 font-medium">Offline</span>
            </div>
            <button id="loadSampleBtn" class="px-4 py-2 bg-ink-700 text-electric-500 border border-electric-500 rounded font-bold text-sm hover:bg-ink-600 transition-all">LOAD SAMPLE DATA</button>
            <button id="uploadBtn" class="px-4 py-2 bg-electric-500 text-ink-950 rounded font-bold text-sm hover:bg-electric-400 transition-all">UPLOAD DATA</button>
        </div>
    </div>

    <div class="flex h-[calc(100vh-73px)]">
        <div class="w-80 border-r border-ink-700 p-6 overflow-y-auto no-print">
            <div class="space-y-4">
                <div class="metric-card rounded-lg p-4">
                    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Total Records</div>
                    <div id="metricTotal" class="stat-number">0</div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="metric-card rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">Positive</div>
                        <div id="metricPositive" class="text-xl font-bold text-success-500">0%</div>
                    </div>
                    <div class="metric-card rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">Negative</div>
                        <div id="metricNegative" class="text-xl font-bold text-warning-500">0%</div>
                    </div>
                </div>
                <div class="metric-card rounded-lg p-4">
                    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Critical Issues</div>
                    <div id="metricCritical" class="stat-number text-warning-500">0</div>
                </div>
                <div class="metric-card rounded-lg p-4">
                    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Locations</div>
                    <div id="metricLocations" class="stat-number">0</div>
                </div>
                <div class="metric-card rounded-lg p-4">
                    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2"><span id="sentimentLabel">Sentiment</span> Score</div>
                    <div id="metricSentiment" class="stat-number">0.00</div>
                </div>

                <div class="mt-8 pt-6 border-t border-ink-700">
                    <h3 class="text-sm font-bold text-electric-500 mb-4">REPORT GENERATION</h3>
                    
                    <label class="block text-xs text-gray-400 mb-2">Report Title</label>
                    <input id="reportTitle" type="text" placeholder="Evidence Analysis Report" 
                           class="w-full bg-ink-800 border border-ink-600 rounded px-3 py-2 text-sm text-white mb-4">
                    
                    <label class="block text-xs text-gray-400 mb-2">Date Range</label>
                    <select id="dateRange" class="w-full bg-ink-800 border border-ink-600 rounded px-3 py-2 text-sm text-white mb-4">
                        <option value="all">All Data</option>
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>

                    <div class="mb-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="includeCharts" checked class="w-4 h-4">
                            <span class="text-xs text-gray-300">Include Charts</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer mt-2">
                            <input type="checkbox" id="includeMap" checked class="w-4 h-4">
                            <span class="text-xs text-gray-300">Include Map</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer mt-2">
                            <input type="checkbox" id="includeDataTable" checked class="w-4 h-4">
                            <span class="text-xs text-gray-300">Include Data Table</span>
                        </label>
                    </div>

                    <div class="bg-ink-800 border border-ink-600 rounded-lg p-4 mb-4">
                        <label class="flex items-center gap-2 cursor-pointer mb-3">
                            <input type="checkbox" id="enableAI" class="w-4 h-4">
                            <span class="text-sm font-bold text-electric-500">Enable AI Insights</span>
                        </label>
                        <div id="aiOptions" class="hidden space-y-3">
                            <input id="geminiApiKey" type="password" placeholder="Gemini API Key" 
                                   class="w-full bg-ink-900 border border-ink-600 rounded px-3 py-2 text-xs text-white">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="aiExecutiveSummary" checked class="w-3 h-3">
                                <span class="text-xs text-gray-300">Executive Summary</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="aiKeyThemes" checked class="w-3 h-3">
                                <span class="text-xs text-gray-300">Key Themes Analysis</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="aiRecommendations" checked class="w-3 h-3">
                                <span class="text-xs text-gray-300">Recommendations</span>
                            </label>
                        </div>
                    </div>

                    <button id="generateReportBtn" disabled 
                            class="w-full px-4 py-3 bg-electric-500 text-ink-950 rounded font-bold text-sm hover:bg-electric-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        GENERATE REPORT
                    </button>

                    <button id="printReportBtn" disabled
                            class="w-full mt-2 px-4 py-2 bg-ink-700 text-white rounded font-bold text-sm hover:bg-ink-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        SAVE AS PDF
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-hidden">
            <div class="flex gap-2 px-6 py-4 border-b border-ink-700 no-print">
                <button id="btnDashboard" onclick="switchView('dashboard')" class="px-3 py-1.5 rounded text-xs font-bold bg-electric-500 text-ink-950 transition-all">DASHBOARD</button>
                <button id="btnReport" onclick="switchView('report')" class="px-3 py-1.5 rounded text-xs font-bold text-gray-400 hover:text-white transition-all">REPORT</button>
                <button id="btnGrid" onclick="switchView('grid')" class="px-3 py-1.5 rounded text-xs font-bold text-gray-400 hover:text-white transition-all">DATA</button>
                <button id="btnMap" onclick="switchView('map')" class="px-3 py-1.5 rounded text-xs font-bold text-gray-400 hover:text-white transition-all">MAP</button>
                <button id="btnCharts" onclick="switchView('charts')" class="px-3 py-1.5 rounded text-xs font-bold text-gray-400 hover:text-white transition-all">CHARTS</button>
                
                <select id="filterSelect" onchange="applyFilter()" class="ml-auto bg-ink-800 border border-ink-600 rounded px-3 py-1 text-xs text-white">
                    <option value="all">All Sentiment</option>
                    <option value="positive">Positive</option>
                    <option value="negative">Negative</option>
                    <option value="critical">Critical</option>
                    <option value="neutral">Neutral</option>
                </select>
            </div>

            <div id="viewDashboard" class="p-6 overflow-y-auto h-[calc(100vh-145px)]">
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <div class="metric-card rounded-lg p-6">
                        <h3 class="text-xs text-gray-400 uppercase tracking-wider mb-4">Sentiment Distribution</h3>
                        <canvas id="sentimentChart"></canvas>
                    </div>
                    <div class="metric-card rounded-lg p-6">
                        <h3 class="text-xs text-gray-400 uppercase tracking-wider mb-4">Top Categories</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="metric-card rounded-lg p-6">
                        <h3 class="text-xs text-gray-400 uppercase tracking-wider mb-4">Severity Levels</h3>
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="metric-card rounded-lg p-6">
                        <h3 class="text-xs text-gray-400 uppercase tracking-wider mb-4">Sentiment Trend</h3>
                        <canvas id="trendChart"></canvas>
                    </div>
                    <div class="metric-card rounded-lg p-6">
                        <h3 class="text-xs text-gray-400 uppercase tracking-wider mb-4">Location Sentiment</h3>
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="viewReport" class="hidden p-6 overflow-y-auto h-[calc(100vh-145px)]">
                <div id="reportOutput" class="text-white">
                    <p class="text-center text-gray-500 py-20">Generate a report to see results here</p>
                </div>
            </div>

            <div id="viewGrid" class="hidden overflow-y-auto h-[calc(100vh-145px)]">
                <div class="grid grid-cols-12 gap-4 px-6 py-3 border-b border-ink-700 text-xs text-gray-400 font-bold uppercase tracking-wider">
                    <div class="col-span-1">#</div>
                    <div class="col-span-3">Content</div>
                    <div class="col-span-2">Category</div>
                    <div class="col-span-2">Location</div>
                    <div class="col-span-2">Sentiment</div>
                    <div class="col-span-1">Score</div>
                    <div class="col-span-1 text-right">Date</div>
                </div>
                <div id="dataGrid"></div>
            </div>

            <div id="viewMap" class="hidden h-[calc(100vh-145px)]">
                <div id="map" style="height: 100%; width: 100%;"></div>
            </div>

            <div id="viewCharts" class="hidden p-6 overflow-y-auto h-[calc(100vh-145px)]">
                <div class="grid grid-cols-2 gap-6">
                    <div class="metric-card rounded-lg p-6">
                        <h3 class="text-sm font-bold mb-4">Sentiment Distribution</h3>
                        <canvas id="sentimentChart2"></canvas>
                    </div>
                    <div class="metric-card rounded-lg p-6">
                        <h3 class="text-sm font-bold mb-4">Categories</h3>
                        <canvas id="categoryChart2"></canvas>
                    </div>
                    <div class="metric-card rounded-lg p-6">
                        <h3 class="text-sm font-bold mb-4">Trend Over Time</h3>
                        <canvas id="trendChart2"></canvas>
                    </div>
                    <div class="metric-card rounded-lg p-6">
                        <h3 class="text-sm font-bold mb-4">Location Analysis</h3>
                        <canvas id="locationChart2"></canvas>
                    </div>
                    <div class="metric-card rounded-lg p-6 col-span-2">
                        <h3 class="text-sm font-bold mb-4">Severity Distribution</h3>
                        <canvas id="severityChart2"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailPanel" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 no-print" onclick="closeDetail()">
        <div class="bg-ink-900 border border-electric-500 rounded-lg p-8 max-w-2xl w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <div id="detailSentiment" class="text-sm font-bold mb-2"></div>
                    <div class="flex gap-4 text-xs text-gray-400">
                        <span>Score: <strong id="detailScore" class="text-white">0.000</strong></span>
                        <span>Confidence: <strong id="detailConfidence" class="text-white">0%</strong></span>
                    </div>
                </div>
                <button onclick="closeDetail()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="bg-ink-800 rounded p-4 mb-4 text-sm leading-relaxed" id="detailContent"></div>
            <div class="mb-4">
                <div class="text-xs text-gray-400 mb-2">Detected Patterns:</div>
                <div id="detailPatterns" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="text-xs text-gray-400">Location: <span id="detailLocation" class="text-white"></span></div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden">

    <script>
        // GLOBAL STATE
        const Store = {
            rawData: [],
            processedData: [],
            headers: [],
            currentFilter: 'all',
            map: null,
            markers: [],
            reportData: null
        };

        const ChartRegistry = {
            sentiment: null, category: null, trend: null, location: null, severity: null,
            sentiment2: null, category2: null, trend2: null, location2: null, severity2: null
        };

        // SENTIMENT LEXICON
        const sentimentWords = {
            positive: ['excellent', 'great', 'amazing', 'wonderful', 'fantastic', 'love', 'best', 'perfect', 'awesome', 'outstanding', 'brilliant', 'superb', 'exceptional', 'impressive', 'helpful', 'friendly', 'clean', 'beautiful', 'delicious', 'comfortable', 'professional', 'recommend', 'satisfied', 'happy', 'pleased', 'thank', 'appreciate', 'good', 'nice', 'quality', 'fast', 'easy'],
            negative: ['bad', 'terrible', 'awful', 'horrible', 'poor', 'worst', 'hate', 'disappointing', 'disappointed', 'frustrating', 'annoying', 'slow', 'rude', 'dirty', 'broken', 'problem', 'issue', 'complaint', 'unhappy', 'upset', 'angry', 'disgusting', 'unacceptable', 'never', 'waste', 'useless', 'fail', 'failed'],
            critical: ['emergency', 'danger', 'unsafe', 'violation', 'illegal', 'fraud', 'scam', 'theft', 'assault', 'abuse', 'discriminat', 'harass', 'threat', 'lawsuit', 'criminal', 'urgent', 'severe', 'serious', 'critical', 'catastrophic']
        };

        // INITIALIZATION
        document.getElementById('uploadBtn').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = handleFileUpload;
        document.getElementById('loadSampleBtn').onclick = loadSampleData;
        document.getElementById('generateReportBtn').onclick = generateReport;
        document.getElementById('printReportBtn').onclick = printReport;
        document.getElementById('enableAI').onchange = (e) => {
            document.getElementById('aiOptions').classList.toggle('hidden', !e.target.checked);
        };

        function loadSampleData() {
            updateEngineStatus('processing', 'Loading Sample...');
            const sampleData = [
                { feedback: "Excellent customer service! The staff went above and beyond to help me find what I needed.", category: "Customer Service", location: "New York", date: "2024-01-15", lat: 40.7128, lng: -74.0060 },
                { feedback: "Long wait times at checkout. Very frustrating experience.", category: "Operations", location: "Los Angeles", date: "2024-01-16", lat: 34.0522, lng: -118.2437 },
                { feedback: "Store was dirty and disorganized. Disappointed with the cleanliness.", category: "Facilities", location: "Chicago", date: "2024-01-17", lat: 41.8781, lng: -87.6298 },
                { feedback: "Amazing product quality! Best purchase I've made this year.", category: "Product", location: "Houston", date: "2024-01-18", lat: 29.7604, lng: -95.3698 },
                { feedback: "Critical safety issue - wet floor with no warning sign. Someone could get hurt!", category: "Safety", location: "Phoenix", date: "2024-01-19", lat: 33.4484, lng: -112.0740 },
                { feedback: "The new store layout is fantastic. Easy to find everything.", category: "Store Design", location: "Philadelphia", date: "2024-01-20", lat: 39.9526, lng: -75.1652 },
                { feedback: "Terrible return policy. Very unhappy with how my complaint was handled.", category: "Policy", location: "San Antonio", date: "2024-01-21", lat: 29.4241, lng: -98.4936 },
                { feedback: "Staff was rude and unhelpful. Worst shopping experience ever.", category: "Customer Service", location: "San Diego", date: "2024-01-22", lat: 32.7157, lng: -117.1611 },
                { feedback: "Great prices and wonderful deals. Will definitely come back!", category: "Pricing", location: "Dallas", date: "2024-01-23", lat: 32.7767, lng: -96.7970 },
                { feedback: "Emergency situation - fire alarm system appears to be broken.", category: "Safety", location: "San Jose", date: "2024-01-24", lat: 37.3382, lng: -121.8863 },
                { feedback: "Love the mobile app. Makes shopping so much easier and convenient.", category: "Technology", location: "Austin", date: "2024-01-25", lat: 30.2672, lng: -97.7431 },
                { feedback: "Parking lot is too small. Had to wait 20 minutes for a spot.", category: "Facilities", location: "Jacksonville", date: "2024-01-26", lat: 30.3322, lng: -81.6557 },
                { feedback: "Outstanding quality and the staff is always friendly and helpful!", category: "Customer Service", location: "Fort Worth", date: "2024-01-27", lat: 32.7555, lng: -97.3308 },
                { feedback: "Poor inventory management. Items are always out of stock.", category: "Operations", location: "Columbus", date: "2024-01-28", lat: 39.9612, lng: -82.9988 },
                { feedback: "Superb experience! Everything was perfect from start to finish.", category: "Overall", location: "Charlotte", date: "2024-01-29", lat: 35.2271, lng: -80.8431 },
                { feedback: "The checkout process is painfully slow. Need more cashiers.", category: "Operations", location: "San Francisco", date: "2024-01-30", lat: 37.7749, lng: -122.4194 },
                { feedback: "Beautiful store design. Very modern and clean environment.", category: "Store Design", location: "Indianapolis", date: "2024-01-31", lat: 39.7684, lng: -86.1581 },
                { feedback: "Fraud alert - was charged twice for the same item!", category: "Billing", location: "Seattle", date: "2024-02-01", lat: 47.6062, lng: -122.3321 },
                { feedback: "Awesome selection of products. Found exactly what I was looking for.", category: "Product", location: "Denver", date: "2024-02-02", lat: 39.7392, lng: -104.9903 },
                { feedback: "Website is broken. Can't complete online orders.", category: "Technology", location: "Washington", date: "2024-02-03", lat: 38.9072, lng: -77.0369 },
                { feedback: "Professional and courteous staff. Very impressed with the service.", category: "Customer Service", location: "Boston", date: "2024-02-04", lat: 42.3601, lng: -71.0589 },
                { feedback: "Restrooms are disgusting. Needs immediate cleaning attention.", category: "Facilities", location: "Nashville", date: "2024-02-05", lat: 36.1627, lng: -86.7816 },
                { feedback: "Brilliant customer loyalty program. Great rewards and benefits.", category: "Program", location: "Detroit", date: "2024-02-06", lat: 42.3314, lng: -83.0458 },
                { feedback: "Delivery was late and items were damaged. Very disappointed.", category: "Delivery", location: "Portland", date: "2024-02-07", lat: 45.5152, lng: -122.6784 },
                { feedback: "Fast and easy checkout with self-service kiosks. Love it!", category: "Technology", location: "Las Vegas", date: "2024-02-08", lat: 36.1699, lng: -115.1398 },
                { feedback: "Harassment complaint - staff member made inappropriate comments.", category: "HR", location: "Memphis", date: "2024-02-09", lat: 35.1495, lng: -90.0490 },
                { feedback: "Exceptional product knowledge from the team. Very helpful!", category: "Customer Service", location: "Louisville", date: "2024-02-10", lat: 38.2527, lng: -85.7585 },
                { feedback: "Parking lot lighting is broken. Unsafe at night.", category: "Safety", location: "Baltimore", date: "2024-02-11", lat: 39.2904, lng: -76.6122 },
                { feedback: "Quality has improved significantly. Very satisfied with recent changes.", category: "Product", location: "Milwaukee", date: "2024-02-12", lat: 43.0389, lng: -87.9065 },
                { feedback: "Annoying music too loud. Couldn't concentrate on shopping.", category: "Environment", location: "Albuquerque", date: "2024-02-13", lat: 35.0844, lng: -106.6504 },
                { feedback: "Clean, organized, and well-stocked. Perfect shopping experience!", category: "Overall", location: "Tucson", date: "2024-02-14", lat: 32.2226, lng: -110.9747 },
                { feedback: "Slow response to customer inquiries. Communication needs improvement.", category: "Customer Service", location: "Fresno", date: "2024-02-15", lat: 36.7378, lng: -119.7871 },
                { feedback: "Fantastic deals during the sale! Saved so much money.", category: "Pricing", location: "Sacramento", date: "2024-01-16", lat: 38.5816, lng: -121.4944 },
                { feedback: "Theft occurred - security needs to be improved immediately.", category: "Security", location: "Mesa", date: "2024-01-17", lat: 33.4152, lng: -111.8315 },
                { feedback: "Comfortable shopping environment. Well air-conditioned and spacious.", category: "Environment", location: "Kansas City", date: "2024-01-18", lat: 39.0997, lng: -94.5786 },
                { feedback: "Product description was misleading. Got something different than expected.", category: "Product", location: "Atlanta", date: "2024-01-19", lat: 33.7490, lng: -84.3880 },
                { feedback: "Brilliant store manager who resolved my issue quickly and professionally.", category: "Management", location: "Virginia Beach", date: "2024-01-20", lat: 36.8529, lng: -75.9780 },
                { feedback: "Unfair pricing compared to competitors. Too expensive.", category: "Pricing", location: "Omaha", date: "2024-01-21", lat: 41.2565, lng: -95.9345 },
                { feedback: "Thank you for the wonderful shopping experience! Will recommend to friends.", category: "Overall", location: "Colorado Springs", date: "2024-01-22", lat: 38.8339, lng: -104.8214 },
                { feedback: "Violation of health code - food safety concerns in the deli section.", category: "Safety", location: "Raleigh", date: "2024-01-23", lat: 35.7796, lng: -78.6382 },
                { feedback: "Appreciate the extended hours. Very convenient for working professionals.", category: "Operations", location: "Miami", date: "2024-01-24", lat: 25.7617, lng: -80.1918 },
                { feedback: "Never shopping here again. Terrible experience from start to finish.", category: "Overall", location: "Oakland", date: "2024-01-25", lat: 37.8044, lng: -122.2712 },
                { feedback: "Good value for money. Satisfied with the quality of products.", category: "Product", location: "Minneapolis", date: "2024-01-26", lat: 44.9778, lng: -93.2650 },
                { feedback: "Issue with disabled access - ramp is too steep and dangerous.", category: "Accessibility", location: "Tulsa", date: "2024-01-27", lat: 36.1539, lng: -95.9928 },
                { feedback: "Nice variety of organic and healthy options. Impressed!", category: "Product", location: "Cleveland", date: "2024-01-28", lat: 41.4993, lng: -81.6944 },
                { feedback: "Failed to deliver on promises. Marketing was deceptive.", category: "Marketing", location: "Wichita", date: "2024-01-29", lat: 37.6872, lng: -97.3301 },
                { feedback: "Useless customer support. Nobody could help with my question.", category: "Customer Service", location: "Arlington", date: "2024-01-30", lat: 32.7357, lng: -97.1081 },
                { feedback: "Nice touch with the free coffee station. Small things make a difference!", category: "Amenities", location: "New Orleans", date: "2024-01-31", lat: 29.9511, lng: -90.0715 },
                { feedback: "Waste of time and money. Regret coming here.", category: "Overall", location: "Bakersfield", date: "2024-02-01", lat: 35.3733, lng: -119.0187 },
                { feedback: "Recommend hiring more staff during peak hours. Understaffed.", category: "Operations", location: "Tampa", date: "2024-02-02", lat: 27.9506, lng: -82.4572 }
            ];
            
            Store.rawData = sampleData;
            Store.headers = Object.keys(sampleData[0]);
            processData();
            updateMetrics();
            renderGrid();
            initializeMap();
            renderCharts();
            switchView('dashboard');
            document.getElementById('generateReportBtn').disabled = false;
            updateEngineStatus('ready', 'Sample Data Loaded');
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            updateEngineStatus('processing', 'Processing...');
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                Store.rawData = jsonData;
                Store.headers = Object.keys(jsonData[0] || {});
                processData();
                updateMetrics();
                renderGrid();
                initializeMap();
                renderCharts();
                switchView('dashboard');
                document.getElementById('generateReportBtn').disabled = false;
                updateEngineStatus('ready', 'Ready');
            };
            reader.readAsArrayBuffer(file);
        }

        function processData() {
            Store.processedData = Store.rawData.map(row => {
                const textCol = findColumn(['feedback', 'comment', 'text', 'content', 'review']);
                const text = String(row[textCol] || '').toLowerCase();
                let score = 0;
                let patterns = [];
                
                // Sentiment analysis
                Object.entries(sentimentWords).forEach(([sentiment, words]) => {
                    words.forEach(word => {
                        const regex = new RegExp(`\\b${word}`, 'gi');
                        const matches = text.match(regex);
                        if (matches) {
                            const wordScore = sentiment === 'positive' ? 0.3 : sentiment === 'critical' ? -0.8 : -0.4;
                            score += wordScore * matches.length;
                            patterns.push({ word, score: wordScore, count: matches.length });
                        }
                    });
                });

                // Normalize score
                score = Math.max(-1, Math.min(1, score));
                
                // Determine sentiment category
                let sentimentLabel = 'neutral';
                if (score < -0.5) sentimentLabel = 'critical';
                else if (score < -0.15) sentimentLabel = 'negative';
                else if (score > 0.15) sentimentLabel = 'positive';

                return {
                    ...row,
                    _score: score,
                    _sentiment: sentimentLabel,
                    _confidence: Math.min(0.95, Math.abs(score) * 0.8 + 0.2),
                    _patterns: patterns.sort((a, b) => Math.abs(b.score) - Math.abs(a.score))
                };
            });
        }

        function updateMetrics() {
            const total = Store.processedData.length;
            if (total === 0) return;
            const positive = Store.processedData.filter(r => r._sentiment === 'positive').length;
            const negative = Store.processedData.filter(r => r._sentiment === 'negative').length;
            const critical = Store.processedData.filter(r => r._sentiment === 'critical').length;
            const avgScore = Store.processedData.reduce((sum, r) => sum + r._score, 0) / total;
            document.getElementById('metricTotal').textContent = total;
            document.getElementById('metricPositive').textContent = `${((positive/total)*100).toFixed(0)}%`;
            document.getElementById('metricNegative').textContent = `${((negative/total)*100).toFixed(0)}%`;
            document.getElementById('metricCritical').textContent = critical;
            document.getElementById('metricLocations').textContent = new Set(Store.processedData.map(r => r.location || r.Location).filter(Boolean)).size;
            const sentimentEl = document.getElementById('metricSentiment');
            sentimentEl.textContent = avgScore.toFixed(2);
            if (avgScore > 0.3) { sentimentEl.className = 'stat-number sentiment-positive'; document.getElementById('sentimentLabel').textContent = 'Positive'; } 
            else if (avgScore < -0.3) { sentimentEl.className = 'stat-number sentiment-negative'; document.getElementById('sentimentLabel').textContent = 'Negative'; } 
            else { sentimentEl.className = 'stat-number sentiment-neutral'; document.getElementById('sentimentLabel').textContent = 'Mixed'; }
        }

        function renderGrid() {
            const container = document.getElementById('dataGrid'); container.innerHTML = '';
            const filtered = getFilteredData();
            filtered.forEach((row, idx) => {
                const textCol = findColumn(['feedback', 'comment', 'text', 'content', 'review']); const catCol = findColumn(['category', 'type', 'department']); const locCol = findColumn(['location', 'city', 'place']); const dateCol = findColumn(['date', 'timestamp', 'created']);
                const rowEl = document.createElement('div'); rowEl.className = 'data-row grid grid-cols-12 gap-4 px-6 py-4 cursor-pointer'; rowEl.onclick = () => showDetail(row);
                const sentimentIcon = row._sentiment === 'positive' ? 'âœ“' : row._sentiment === 'critical' ? 'ðŸ”¥' : row._sentiment === 'negative' ? 'âš ' : 'â—‹';
                rowEl.innerHTML = `<div class="col-span-1 text-gray-600 text-xs font-mono">${idx + 1}</div><div class="col-span-3 text-sm text-white truncate">${row[textCol] || '-'}</div><div class="col-span-2 text-xs"><span class="tag">${row[catCol] || 'General'}</span></div><div class="col-span-2 text-xs text-gray-400">${row[locCol] || 'N/A'}</div><div class="col-span-2 text-sm font-semibold ${getSentimentClass(row._sentiment)}">${sentimentIcon} ${row._sentiment || 'neutral'}</div><div class="col-span-1 text-sm font-mono text-gray-300">${row._score.toFixed(2)}</div><div class="col-span-1 text-right text-xs text-gray-600">${formatDate(row[dateCol])}</div>`;
                container.appendChild(rowEl);
            });
        }
        function getFilteredData() { return Store.currentFilter === 'all' ? Store.processedData : Store.processedData.filter(r => r._sentiment === Store.currentFilter); }
        function applyFilter() { Store.currentFilter = document.getElementById('filterSelect').value; renderGrid(); updateMapMarkers(); }
        function initializeMap() { if (!Store.map) { Store.map = L.map('map').setView([39.8283, -98.5795], 4); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(Store.map); } updateMapMarkers(); }
        function updateMapMarkers() { Store.markers.forEach(m => Store.map.removeLayer(m)); Store.markers = []; const latCol = findColumn(['lat', 'latitude']); const lngCol = findColumn(['lng', 'longitude', 'lon']); if (!latCol || !lngCol) return; const filtered = getFilteredData(); filtered.forEach(row => { const lat = parseFloat(row[latCol]); const lng = parseFloat(row[lngCol]); if (!isNaN(lat) && !isNaN(lng)) { const color = row._sentiment === 'positive' ? '#00ff88' : row._sentiment === 'critical' ? '#ff3333' : row._sentiment === 'negative' ? '#ff6b35' : '#808080'; const marker = L.circleMarker([lat, lng], { radius: 8, fillColor: color, color: color, weight: 2, opacity: 0.8, fillOpacity: 0.6 }).addTo(Store.map); Store.markers.push(marker); } }); }
        
        function renderCharts() { renderSentimentChart(); renderCategoryChart(); renderTrendChart(); renderLocationChart(); renderSeverityChart(); }
        function renderSentimentChart() { 
            ['sentimentChart', 'sentimentChart2'].forEach(canvasId => {
                const ctx = document.getElementById(canvasId); if (!ctx) return; 
                const chartKey = canvasId === 'sentimentChart' ? 'sentiment' : 'sentiment2';
                if (ChartRegistry[chartKey]) { ChartRegistry[chartKey].destroy(); ChartRegistry[chartKey] = null; } 
                const counts = { positive: Store.processedData.filter(r => r._sentiment === 'positive').length, negative: Store.processedData.filter(r => r._sentiment === 'negative').length, critical: Store.processedData.filter(r => r._sentiment === 'critical').length, neutral: Store.processedData.filter(r => r._sentiment === 'neutral').length }; 
                ChartRegistry[chartKey] = new Chart(ctx, { type: 'doughnut', data: { labels: ['Positive', 'Negative', 'Critical', 'Neutral'], datasets: [{ data: [counts.positive, counts.negative, counts.critical, counts.neutral], backgroundColor: ['#00ff88', '#ff6b35', '#ff3333', '#808080'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#e0e0e0', padding: 15, font: { size: 11 } } } } } });
            });
        }
        function renderCategoryChart() { 
            ['categoryChart', 'categoryChart2'].forEach(canvasId => {
                const ctx = document.getElementById(canvasId); if (!ctx) return; 
                const chartKey = canvasId === 'categoryChart' ? 'category' : 'category2';
                if (ChartRegistry[chartKey]) { ChartRegistry[chartKey].destroy(); ChartRegistry[chartKey] = null; } 
                const catCol = findColumn(['category', 'type', 'department']); if (!catCol) return; 
                const categories = {}; Store.processedData.forEach(r => { const cat = r[catCol] || 'Other'; if (!categories[cat]) categories[cat] = 0; categories[cat]++; }); 
                const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]).slice(0, 6); 
                ChartRegistry[chartKey] = new Chart(ctx, { type: 'bar', data: { labels: sorted.map(c => c[0]), datasets: [{ label: 'Total', data: sorted.map(c => c[1]), backgroundColor: '#00f0ff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#808080' }, grid: { color: '#2d2d2d' } }, x: { ticks: { color: '#808080' }, grid: { display: false } } } } });
            });
        }
        function renderTrendChart() { 
            ['trendChart', 'trendChart2'].forEach(canvasId => {
                const ctx = document.getElementById(canvasId); if (!ctx) return; 
                const chartKey = canvasId === 'trendChart' ? 'trend' : 'trend2';
                if (ChartRegistry[chartKey]) { ChartRegistry[chartKey].destroy(); ChartRegistry[chartKey] = null; } 
                const dateCol = findColumn(['date', 'timestamp', 'created']); if (!dateCol) return; 
                const dateGroups = {}; Store.processedData.forEach(r => { const date = formatDate(r[dateCol]); if (!dateGroups[date]) dateGroups[date] = []; dateGroups[date].push(r._score); }); 
                const dates = Object.keys(dateGroups).sort(); const avgScores = dates.map(d => dateGroups[d].reduce((a, b) => a + b, 0) / dateGroups[d].length); 
                ChartRegistry[chartKey] = new Chart(ctx, { type: 'line', data: { labels: dates, datasets: [{ label: 'Sentiment', data: avgScores, borderColor: '#00f0ff', backgroundColor: 'rgba(0, 240, 255, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#808080' }, grid: { color: '#2d2d2d' } }, x: { ticks: { color: '#808080', maxRotation: 45 }, grid: { display: false } } } } });
            });
        }
        function renderLocationChart() { 
            ['locationChart', 'locationChart2'].forEach(canvasId => {
                const ctx = document.getElementById(canvasId); if (!ctx) return; 
                const chartKey = canvasId === 'locationChart' ? 'location' : 'location2';
                if (ChartRegistry[chartKey]) { ChartRegistry[chartKey].destroy(); ChartRegistry[chartKey] = null; } 
                const locCol = findColumn(['location', 'city', 'place']); if (!locCol) return; 
                const locations = {}; Store.processedData.forEach(r => { const loc = r[locCol] || 'Unknown'; if (!locations[loc]) locations[loc] = []; locations[loc].push(r._score); }); 
                const sorted = Object.entries(locations).map(([name, scores]) => ({ name, avg: scores.reduce((a, b) => a + b, 0) / scores.length })).sort((a, b) => a.avg - b.avg).slice(0, 8); 
                ChartRegistry[chartKey] = new Chart(ctx, { type: 'bar', data: { labels: sorted.map(l => l.name), datasets: [{ label: 'Sentiment', data: sorted.map(l => l.avg), backgroundColor: sorted.map(l => l.avg < 0 ? '#ff6b35' : '#00ff88') }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#808080' }, grid: { color: '#2d2d2d' } }, y: { ticks: { color: '#808080' }, grid: { display: false } } } } });
            });
        }
        function renderSeverityChart() { 
            ['severityChart', 'severityChart2'].forEach(canvasId => {
                const ctx = document.getElementById(canvasId); if (!ctx) return; 
                const chartKey = canvasId === 'severityChart' ? 'severity' : 'severity2';
                if (ChartRegistry[chartKey]) { ChartRegistry[chartKey].destroy(); ChartRegistry[chartKey] = null; } 
                const counts = [0, 0, 0, 0, 0]; Store.processedData.forEach(r => { if (r._score < -0.5) counts[0]++; else if (r._score < -0.2) counts[1]++; else if (r._score < 0.2) counts[2]++; else if (r._score < 0.5) counts[3]++; else counts[4]++; }); 
                ChartRegistry[chartKey] = new Chart(ctx, { type: 'bar', data: { labels: ['Critical', 'Negative', 'Neutral', 'Positive', 'Excellent'], datasets: [{ data: counts, backgroundColor: ['#ff3333', '#ff6b35', '#808080', '#00ff88', '#00f0ff'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#808080' }, grid: { color: '#2d2d2d' } }, x: { ticks: { color: '#808080' }, grid: { display: false } } } } });
            });
        }

        function showDetail(row) { document.getElementById('detailPanel').classList.remove('hidden'); const textCol = findColumn(['feedback', 'comment', 'text', 'content']); const locCol = findColumn(['location', 'city', 'place']); document.getElementById('detailContent').textContent = row[textCol] || 'No content'; const sentEl = document.getElementById('detailSentiment'); sentEl.textContent = (row._sentiment || 'neutral').toUpperCase(); sentEl.className = `text-sm font-bold ${getSentimentClass(row._sentiment)}`; document.getElementById('detailScore').textContent = row._score.toFixed(3); document.getElementById('detailConfidence').textContent = `${(row._confidence * 100).toFixed(0)}%`; const patternsEl = document.getElementById('detailPatterns'); patternsEl.innerHTML = ''; if (row._patterns && row._patterns.length > 0) { row._patterns.slice(0, 8).forEach(p => { const tag = document.createElement('span'); tag.className = 'tag'; tag.textContent = `${p.word} (${p.score > 0 ? '+' : ''}${p.score.toFixed(1)})`; patternsEl.appendChild(tag); }); } else { patternsEl.innerHTML = '<span class="text-xs text-gray-600">No patterns detected</span>'; } document.getElementById('detailLocation').textContent = row[locCol] || 'Unknown location'; }
        function closeDetail() { document.getElementById('detailPanel').classList.add('hidden'); }
        
        function switchView(view) { 
            ['viewDashboard', 'viewReport', 'viewGrid', 'viewMap', 'viewCharts'].forEach(id => document.getElementById(id).classList.add('hidden'));
            ['btnDashboard', 'btnReport', 'btnGrid', 'btnMap', 'btnCharts'].forEach(id => { document.getElementById(id).className = 'px-3 py-1.5 rounded text-xs font-bold text-gray-400 hover:text-white transition-all'; });
            
            if (view === 'dashboard') { 
                document.getElementById('viewDashboard').classList.remove('hidden'); 
                document.getElementById('btnDashboard').className = 'px-3 py-1.5 rounded text-xs font-bold bg-electric-500 text-ink-950 transition-all'; 
                renderCharts();
            } else if (view === 'report') { 
                document.getElementById('viewReport').classList.remove('hidden'); 
                document.getElementById('btnReport').className = 'px-3 py-1.5 rounded text-xs font-bold bg-electric-500 text-ink-950 transition-all'; 
            } else if (view === 'grid') { 
                document.getElementById('viewGrid').classList.remove('hidden'); 
                document.getElementById('btnGrid').className = 'px-3 py-1.5 rounded text-xs font-bold bg-electric-500 text-ink-950 transition-all'; 
            } else if (view === 'map') { 
                document.getElementById('viewMap').classList.remove('hidden'); 
                document.getElementById('btnMap').className = 'px-3 py-1.5 rounded text-xs font-bold bg-electric-500 text-ink-950 transition-all'; 
                setTimeout(() => Store.map && Store.map.invalidateSize(), 100); 
            } else { 
                document.getElementById('viewCharts').classList.remove('hidden'); 
                document.getElementById('btnCharts').className = 'px-3 py-1.5 rounded text-xs font-bold bg-electric-500 text-ink-950 transition-all'; 
                renderCharts(); 
            } 
        }
        
        function findColumn(keywords) { return Store.headers.find(h => keywords.some(kw => h.toLowerCase().includes(kw))) || Store.headers[0]; }
        function getSentimentClass(sentiment) { if (sentiment === 'positive') return 'sentiment-positive'; if (sentiment === 'negative') return 'sentiment-negative'; if (sentiment === 'critical') return 'text-warning-500'; return 'sentiment-neutral'; }
        function formatDate(val) { if (!val) return '-'; if (typeof val === 'number') { return new Date((val - 25569) * 86400 * 1000).toLocaleDateString(); } return String(val).split('T')[0]; }
        function updateEngineStatus(status, text) { const dot = document.getElementById('engineStatus'); const label = document.getElementById('engineText'); if (status === 'processing') { dot.className = 'w-2 h-2 rounded-full bg-electric-500 pulse-dot'; label.className = 'text-electric-500 font-medium'; } else if (status === 'ready') { dot.className = 'w-2 h-2 rounded-full bg-success-500'; label.className = 'text-success-500 font-medium'; } else { dot.className = 'w-2 h-2 rounded-full bg-gray-500'; label.className = 'text-gray-400 font-medium'; } label.textContent = text; }

        // ==================== DETERMINISTIC-FIRST REPORT GENERATION ====================
        
        async function generateReport() {
            const output = document.getElementById('reportOutput');
            const title = document.getElementById('reportTitle').value || 'Evidence Analysis Report';
            
            // Define textCol explicitly at the top so it is available to both blocks
            const textCol = findColumn(['feedback', 'comment', 'text', 'content', 'review']);

            const includeCharts = document.getElementById('includeCharts').checked;
            const includeMap = document.getElementById('includeMap').checked;
            const includeDataTable = document.getElementById('includeDataTable').checked;
            const enableAI = document.getElementById('enableAI').checked;
            
            updateEngineStatus('processing', 'Generating Report...');

            // --- LOCK BUTTON HERE ---
            document.getElementById('printReportBtn').disabled = true;
            
            // 1. GENERATE DETERMINISTIC HTML (INSTANT)
            let html = `<div class="print-page">`;
            html += `<h1>${title}</h1>`;
            html += `<p class="text-sm text-gray-400">Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>`;
            
            // Executive Summary
            html += `<h2>Executive Summary</h2>`;
            const total = Store.processedData.length;
            const positive = Store.processedData.filter(r => r._sentiment === 'positive').length;
            const negative = Store.processedData.filter(r => r._sentiment === 'negative').length;
            const critical = Store.processedData.filter(r => r._sentiment === 'critical').length;
            const neutral = Store.processedData.filter(r => r._sentiment === 'neutral').length;
            const avgScore = Store.processedData.reduce((sum, r) => sum + r._score, 0) / total;
            
            html += `<div class="report-metric">`;
            html += `<p><strong>Total Records Analyzed:</strong> ${total}</p>`;
            html += `<p><strong>Overall Sentiment Score:</strong> ${avgScore.toFixed(3)} (${avgScore > 0.3 ? 'Positive' : avgScore < -0.3 ? 'Negative' : 'Mixed'})</p>`;
            html += `<p><strong>Distribution:</strong></p>`;
            html += `<ul>`;
            html += `<li>Positive: ${positive} (${((positive/total)*100).toFixed(1)}%)</li>`;
            html += `<li>Negative: ${negative} (${((negative/total)*100).toFixed(1)}%)</li>`;
            html += `<li>Critical: ${critical} (${((critical/total)*100).toFixed(1)}%)</li>`;
            html += `<li>Neutral: ${neutral} (${((neutral/total)*100).toFixed(1)}%)</li>`;
            html += `</ul>`;
            html += `</div>`;
            
            // Key Findings
            html += `<h2>Key Findings</h2>`;
            
            // Top positive and negative patterns
            const allPatterns = {};
            Store.processedData.forEach(row => {
                if (row._patterns) {
                    row._patterns.forEach(p => {
                        if (!allPatterns[p.word]) allPatterns[p.word] = { count: 0, totalScore: 0 };
                        allPatterns[p.word].count += p.count || 1;
                        allPatterns[p.word].totalScore += p.score;
                    });
                }
            });
            
            const sortedPatterns = Object.entries(allPatterns)
                .map(([word, data]) => ({ word, ...data, avgScore: data.totalScore / data.count }))
                .sort((a, b) => Math.abs(b.avgScore) - Math.abs(a.avgScore));
            
            const topPositive = sortedPatterns.filter(p => p.avgScore > 0).slice(0, 5);
            const topNegative = sortedPatterns.filter(p => p.avgScore < 0).slice(0, 5);
            
            html += `<h3>Most Frequent Positive Themes</h3>`;
            html += `<ul>`;
            topPositive.forEach(p => {
                html += `<li><strong>${p.word}</strong>: mentioned ${p.count} times (sentiment +${p.avgScore.toFixed(2)})</li>`;
            });
            html += `</ul>`;
            
            html += `<h3>Most Frequent Negative Themes</h3>`;
            html += `<ul>`;
            topNegative.forEach(p => {
                html += `<li><strong>${p.word}</strong>: mentioned ${p.count} times (sentiment ${p.avgScore.toFixed(2)})</li>`;
            });
            html += `</ul>`;
            
            // Location Analysis
            const locCol = findColumn(['location', 'city', 'place']);
            if (locCol) {
                const locationScores = {};
                Store.processedData.forEach(r => {
                    const loc = r[locCol] || 'Unknown';
                    if (!locationScores[loc]) locationScores[loc] = [];
                    locationScores[loc].push(r._score);
                });
                
                const locationData = Object.entries(locationScores)
                    .map(([name, scores]) => ({
                        name,
                        count: scores.length,
                        avg: scores.reduce((a, b) => a + b, 0) / scores.length
                    }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10);
                
                html += `<h3>Location Analysis</h3>`;
                html += `<table>`;
                html += `<thead><tr><th>Location</th><th>Records</th><th>Avg Sentiment</th></tr></thead>`;
                html += `<tbody>`;
                locationData.forEach(loc => {
                    const sentiment = loc.avg > 0.3 ? 'Positive' : loc.avg < -0.3 ? 'Negative' : 'Mixed';
                    html += `<tr><td>${loc.name}</td><td>${loc.count}</td><td>${loc.avg.toFixed(2)} (${sentiment})</td></tr>`;
                });
                html += `</tbody></table>`;
            }
            
            // Critical Issues
            if (critical > 0) {
                html += `<h2>Critical Issues</h2>`;
                html += `<div class="insight-box">`;
                html += `<p><strong>${critical} critical issues detected</strong> requiring immediate attention.</p>`;
                const criticalRecords = Store.processedData.filter(r => r._sentiment === 'critical').slice(0, 5);
                html += `<h3>Sample Critical Records:</h3>`;
                html += `<ul>`;
                criticalRecords.forEach((r, i) => {
                    html += `<li>"${String(r[textCol]).substring(0, 150)}..." (Score: ${r._score.toFixed(2)})</li>`;
                });
                html += `</ul>`;
                html += `</div>`;
            }
            
            html += `</div>`; // End first page
            
            // Charts (Placeholder)
            if (includeCharts) {
                html += `<div class="print-page">`;
                html += `<h2>Visual Analysis</h2>`;
                html += `<div class="chart-container"><h3>Sentiment Distribution</h3><canvas id="reportSentimentChart"></canvas></div>`;
                html += `<div class="chart-container"><h3>Trend Over Time</h3><canvas id="reportTrendChart"></canvas></div>`;
                html += `</div>`;
            }
            
            // Map (Placeholder)
            if (includeMap) {
                html += `<div class="print-section">`;
                html += `<h2>Geographic Distribution</h2>`;
                html += `<div id="reportMap" style="height: 500px; width: 100%; background: white; border-radius: 8px;"></div>`;
                html += `</div>`;
            }
            
            // Data Table
            if (includeDataTable) {
                html += `<div class="print-page">`;
                html += `<h2>Detailed Data</h2>`;
                const catCol = findColumn(['category', 'type', 'department']);
                const dateCol = findColumn(['date', 'timestamp', 'created']);
                html += `<table>`;
                html += `<thead><tr><th>#</th><th>Content</th><th>Category</th><th>Sentiment</th><th>Score</th><th>Date</th></tr></thead>`;
                html += `<tbody>`;
                Store.processedData.slice(0, 50).forEach((r, i) => {
                    html += `<tr>`;
                    html += `<td>${i + 1}</td>`;
                    html += `<td>${String(r[textCol] || '').substring(0, 80)}...</td>`;
                    html += `<td>${r[catCol] || 'General'}</td>`;
                    html += `<td>${r._sentiment}</td>`;
                    html += `<td>${r._score.toFixed(2)}</td>`;
                    html += `<td>${formatDate(r[dateCol])}</td>`;
                    html += `</tr>`;
                });
                html += `</tbody></table>`;
                html += `</div>`;
            }
            
            // AI Placeholder
            if (enableAI) {
                html += `<div id="aiPlaceholder" class="print-page">`;
                html += `<h2>AI-Generated Insights</h2>`;
                html += `<div class="insight-box"><p class="text-electric-500 pulse-dot">Analyzing patterns... Connecting to Intelligence Engine...</p></div>`;
                html += `</div>`;
            }

            // 2. RENDER IMMEDIATE DETERMINISTIC CONTENT
            output.innerHTML = html;
            switchView('report');
            // document.getElementById('printReportBtn').disabled = false; <-- REMOVED FROM HERE
            
            // 3. RENDER CHARTS AND MAP (These need the DOM elements to exist first)
            if (includeCharts) {
                setTimeout(() => {
                    const sentCtx = document.getElementById('reportSentimentChart');
                    if (sentCtx) {
                        new Chart(sentCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Positive', 'Negative', 'Critical', 'Neutral'],
                                datasets: [{
                                    data: [positive, negative, critical, neutral],
                                    backgroundColor: ['#00ff88', '#ff6b35', '#ff3333', '#808080']
                                }]
                            },
                            // IMPORTANT: Disable animation for PDF export
                            options: { 
                                responsive: true, 
                                maintainAspectRatio: true,
                                animation: { duration: 0 } 
                            }
                        });
                    }
                    
                    const trendCtx = document.getElementById('reportTrendChart');
                    if (trendCtx) {
                        const dateCol = findColumn(['date', 'timestamp', 'created']);
                        const dateGroups = {};
                        Store.processedData.forEach(r => {
                            const date = formatDate(r[dateCol]);
                            if (!dateGroups[date]) dateGroups[date] = [];
                            dateGroups[date].push(r._score);
                        });
                        const dates = Object.keys(dateGroups).sort();
                        const avgScores = dates.map(d => dateGroups[d].reduce((a, b) => a + b, 0) / dateGroups[d].length);
                        
                        new Chart(trendCtx, {
                            type: 'line',
                            data: {
                                labels: dates,
                                datasets: [{
                                    label: 'Sentiment',
                                    data: avgScores,
                                    borderColor: '#00f0ff',
                                    backgroundColor: 'rgba(0, 240, 255, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            // IMPORTANT: Disable animation for PDF export
                            options: { 
                                responsive: true, 
                                maintainAspectRatio: true,
                                animation: { duration: 0 } 
                            }
                        });
                    }
                }, 100);
            }
            
            if (includeMap) {
                setTimeout(() => {
                    const mapEl = document.getElementById('reportMap');
                    if (mapEl) {
                        const reportMap = L.map('reportMap').setView([39.8283, -98.5795], 4);
                        // IMPORTANT: Standard tiles may block cross-origin export. 
                        // Using a standard OSM tile server usually works with useCORS:true
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                            attribution: 'Â© OpenStreetMap',
                            crossOrigin: true
                        }).addTo(reportMap);
                        
                        const latCol = findColumn(['lat', 'latitude']);
                        const lngCol = findColumn(['lng', 'longitude', 'lon']);
                        if (latCol && lngCol) {
                            Store.processedData.forEach(row => {
                                const lat = parseFloat(row[latCol]);
                                const lng = parseFloat(row[lngCol]);
                                if (!isNaN(lat) && !isNaN(lng)) {
                                    const color = row._sentiment === 'positive' ? '#00ff88' : row._sentiment === 'critical' ? '#ff3333' : row._sentiment === 'negative' ? '#ff6b35' : '#808080';
                                    L.circleMarker([lat, lng], { radius: 8, fillColor: color, color: color, weight: 2, opacity: 0.8, fillOpacity: 0.6 }).addTo(reportMap);
                                }
                            });
                        }
                    }
                }, 100);
            }
            
            // --- UNLOCK BUTTON HERE (AFTER RENDERING) ---
            setTimeout(() => {
                document.getElementById('printReportBtn').disabled = false;
                updateEngineStatus('ready', 'Report Generated');
            }, 800); // Buffer to allow ChartJS to finalize

            // 4. FETCH AI ASYNC (OPTIONAL)
            if (enableAI) {
                const apiKey = document.getElementById('geminiApiKey').value;
                if (!apiKey) {
                    document.getElementById('aiPlaceholder').innerHTML = `<h2>AI-Generated Insights</h2><p class="text-warning-500">API Key missing. AI insights skipped.</p>`;
                    return;
                }
                
                try {
                    // Prepare data summary for AI
                    const dataSummary = {
                        total,
                        sentimentDistribution: { positive, negative, critical, neutral },
                        avgScore,
                        topPositive: topPositive.map(p => p.word),
                        topNegative: topNegative.map(p => p.word),
                        samplePositive: Store.processedData.filter(r => r._sentiment === 'positive').slice(0, 3).map(r => r[textCol]),
                        sampleNegative: Store.processedData.filter(r => r._sentiment === 'negative').slice(0, 3).map(r => r[textCol]),
                        sampleCritical: Store.processedData.filter(r => r._sentiment === 'critical').slice(0, 3).map(r => r[textCol])
                    };
                    
                    const aiPrompt = `You are analyzing evidence/feedback data. Here's a summary:
Total records: ${dataSummary.total}
Sentiment distribution: ${JSON.stringify(dataSummary.sentimentDistribution)}
Average sentiment score: ${dataSummary.avgScore.toFixed(3)}
Top positive themes: ${dataSummary.topPositive.join(', ')}
Top negative themes: ${dataSummary.topNegative.join(', ')}
Sample positive feedback: ${JSON.stringify(dataSummary.samplePositive)}
Sample negative feedback: ${JSON.stringify(dataSummary.sampleNegative)}
${dataSummary.sampleCritical.length > 0 ? `Sample critical issues: ${JSON.stringify(dataSummary.sampleCritical)}` : ''}

Please provide:
${document.getElementById('aiExecutiveSummary').checked ? '1. A concise executive summary highlighting the most important insights\n' : ''}
${document.getElementById('aiKeyThemes').checked ? '2. Analysis of key themes and patterns across the data\n' : ''}
${document.getElementById('aiRecommendations').checked ? '3. Actionable recommendations based on the findings\n' : ''}

Format your response in HTML with proper headings (<h3>) and paragraphs (<p>).`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`, {
                    
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: aiPrompt }] }] })
                    });
                    
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    const aiInsight = data.candidates[0].content.parts[0].text;
                    
                    const aiContainer = document.getElementById('aiPlaceholder');
                    if(aiContainer) {
                        aiContainer.innerHTML = `<h2>AI-Generated Insights</h2><div class="insight-box">${aiInsight}</div>`;
                    }
                    
                } catch (error) {
                    const aiContainer = document.getElementById('aiPlaceholder');
                    if(aiContainer) {
                        aiContainer.innerHTML = `<h2>AI-Generated Insights</h2><p class="text-warning-500">Error generating AI insights: ${error.message}</p>`;
                    }
                }
            }
        }
        
        // NEW FIX: WAIT FOR CHARTS TO HAVE DATA
        function waitForChartJS() {
            return new Promise(resolve => {
                const check = () => {
                    const charts = [...document.querySelectorAll('#reportOutput canvas')];
                    // Check if charts exist AND have content (byte size > 1000)
                    if (charts.length > 0 && charts.every(c => c.toDataURL().length > 1000)) {
                        resolve();
                    } else if (charts.length === 0) {
                        resolve(); // No charts to wait for
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        // NEW FIX: WAIT FOR MAP TILES
        async function freezeMapForPDF() {
            const mapDiv = document.getElementById("reportMap");
            if (!mapDiv) return;

            // 1. Remove controls
            mapDiv.querySelectorAll(".leaflet-control").forEach(el => el.remove());

            // 2. Wait for tiles
            const tiles = Array.from(mapDiv.querySelectorAll("img.leaflet-tile"));
            if (tiles.length > 0) {
                await Promise.all(tiles.map(tile => {
                    if (tile.complete) return Promise.resolve();
                    return new Promise(resolve => {
                        tile.onload = resolve;
                        tile.onerror = resolve; 
                    });
                }));
            }
            
            // 3. Small buffer
            await new Promise(r => setTimeout(r, 250));

            // 4. Rasterize
            const canvas = await html2canvas(mapDiv, { useCORS: true, scale: 2 });
            const img = document.createElement("img");
            img.src = canvas.toDataURL("image/png");
            img.style.width = "100%";
            img.style.borderRadius = "8px";
            mapDiv.replaceWith(img);
        }

        async function printReport() {
            const element = document.getElementById('reportOutput');
            const originalClass = element.className;
            element.classList.add('pdf-mode');

            updateEngineStatus('processing','Rendering visuals...');

            // EXECUTE SANCO PROTOCOLS
            await waitForChartJS();
            await freezeMapForPDF();

            // convert remaining charts/canvases to images
            document.querySelectorAll('#reportOutput canvas').forEach(c => {
                const img = document.createElement("img");
                img.src = c.toDataURL("image/png");
                img.style.width = "100%";
                c.replaceWith(img);
            });

            const opt = {
                margin:[0.5,0.5,0.5,0.5],
                filename:`evidence-report-${Date.now()}.pdf`,
                image:{type:'jpeg',quality:0.98},
                html2canvas:{scale:2,useCORS:true},
                jsPDF:{unit:'in',format:'letter'},
                pagebreak:{mode:['css','legacy']}
            };

            await html2pdf().set(opt).from(element).save();

            element.className = originalClass;
            element.classList.add('text-white');
            updateEngineStatus('ready','PDF Saved');
        }
    </script>
</body>
</html>
